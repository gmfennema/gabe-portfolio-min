<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Personal Stats â€¢ Project â€¢ Gabe Fennema</title>
  <meta name="description" content="A live dashboard of my lifting, coffee, and alcohol stats pulled from Google Calendar."/>
  <link rel="stylesheet" href="../styles.css"/>
  <link rel="icon" href="../assets/favicon.png" type="image/png"/>
  <style>
    html[data-theme="dark"] { color-scheme: dark; }
    html[data-theme="light"] { color-scheme: light; }

    /* Layout (borrows structure from your simulator page) */
    .dash{
      margin-top: 24px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 18px;
      align-items: start;
    }
    .panel{
      border: 1px solid var(--rule);
      border-radius: 12px;
      background: var(--bg);
      padding: 16px;
    }
    .panel h2{
      margin: 0 0 12px;
      font-size: 20px;
      line-height: 1.2;
    }

    /* Section rows (grid of tiny squares + metric card on the right like the mock) */
    .section-row{
      display: grid;
      grid-template-columns: 1fr 340px;
      gap: 16px;
      align-items: center;
    }
    @media (max-width: 720px){
      .section-row{ grid-template-columns: 1fr; }
    }

    .metric-card{
      border: 1px solid var(--rule);
      border-radius: 12px;
      background: var(--bg);
      padding: 18px 16px;
      text-align: center;
      min-height: 100px;
      display: grid;
      align-content: center;
      gap: 6px;
    }
    .metrics{ display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
    .metric-card .label{
      color: var(--muted);
      font-size: 12px;
      letter-spacing: .06em;
      text-transform: uppercase;
    }
    .metric-card .value{
      font-size: 34px;
      font-weight: 800;
      line-height: 1;
    }
    .metrics .metric-card .value{ font-size: 28px; }

    /* Activity grids oriented as: rows = Sun..Sat, columns = weeks (old â†’ new) */
    .micro-grid{
      --gap: 4px;
      display: grid;
      grid-auto-flow: column;             /* fill by column: topâ†’bottom, then next column */
      grid-template-rows: repeat(7, 1fr); /* 7 rows for days of week (Sun at top) */
      grid-auto-columns: 1fr;             /* each week column shares available width */
      gap: var(--gap);
      width: 100%;
    }
    .sq{
      aspect-ratio: 1;
      border: 1.2px solid var(--rule);
      border-radius: 3px;
      background: transparent;
      transition: background-color .15s ease, border-color .15s ease, transform .05s ease;
    }
    .sq.on{ background: var(--accent); }
    .sq:hover{ transform: translateY(-1px); }

    /* Titles between rows */
    .row-title{
      font-size: 18px;
      margin: 20px 0 10px;
      color: var(--text);
    }

    /* Subtle page motion */
    @keyframes fade-up{ from{opacity:0; transform:translateY(6px);} to{opacity:1; transform:none;} }
    .panel{ animation: fade-up .35s ease both; }
    
    /* Loading overlay */
    .loader-overlay{
      position: fixed;
      inset: 0;
      background: var(--bg);
      display: grid;
      place-items: center;
      z-index: 2000;
      transition: opacity .25s ease, visibility .25s ease;
    }
    .loader-overlay.hidden{ opacity: 0; visibility: hidden; }
    .loader-box{ display: flex; flex-direction: column; align-items: center; gap: 12px; }
    .spinner{
      width: 52px; height: 52px;
      border-radius: 999px;
      border: 3px solid var(--rule);
      border-top-color: var(--accent);
      animation: spin .9s linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }
    .loader-message{ color: var(--muted); font-size: 14px; text-align: center; max-width: 90%; }
    @media (prefers-reduced-motion: reduce){ .spinner{ animation: none; border-top-color: var(--accent-strong); } }

    /* Pipeline loader: calendar â†’ website with moving packets */
    .loader-pipeline{ display:flex; flex-direction:column; align-items:center; gap: 12px; }
    .pipeline{ display:flex; align-items:center; gap:12px; width: clamp(220px, 50vw, 420px); }
    .pipeline .icon{ line-height: 1; color: var(--muted); }
    .material-symbols-outlined{ font-variation-settings: 'FILL' 0, 'wght' 500, 'GRAD' 0, 'opsz' 250; font-size: 60px!important; }
    .pipeline .flow{
      position: relative;
      flex: 1; height: 2px; border-radius: 999px; overflow: hidden;
      background: var(--muted);
      opacity: .45;
    }
    .pipeline .packet{
      position: absolute; top: 50%; left: 0;
      width: 14px; height: 14px; margin-top: -7px; border-radius: 999px;
      background: var(--accent);
      border: 2px solid var(--text);
      animation: packet-move 1.3s linear infinite;
      will-change: left;
    }
    .pipeline .packet:nth-child(2){ animation-delay: .16s; }
    .pipeline .packet:nth-child(3){ animation-delay: .32s; }
    .pipeline .packet:nth-child(4){ animation-delay: .48s; }
    .pipeline .packet:nth-child(5){ animation-delay: .64s; }
    .pipeline .packet:nth-child(6){ animation-delay: .8s; }
    @keyframes packet-move{
      0%{ left: 0; }
      100%{ left: calc(100% - 14px); }
    }
    @media (prefers-reduced-motion: reduce){
      .pipeline .packet{ animation: none; }
    }
  </style>

  <meta property="og:title" content="Personal Stats â€¢ Project â€¢ Gabe Fennema"/>
  <meta property="og:description" content="A live dashboard of my lifting, coffee, and alcohol stats pulled from Google Calendar."/>
  <meta property="og:type" content="website"/>
  <meta property="og:url" content="personal-stats.html"/>
  <meta name="twitter:card" content="summary"/>
  <meta name="twitter:title" content="Personal Stats â€¢ Project â€¢ Gabe Fennema"/>
  <meta name="twitter:description" content="A live dashboard of my lifting, coffee, and alcohol stats pulled from Google Calendar."/>
  <link rel="canonical" href="personal-stats.html"/>
  <link rel="prefetch" href="../projects.html"/>
  <link rel="prefetch" href="../index.html"/>
  <link rel="prefetch" href="../writing.html"/>

  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@400"/>

  <style>.page-max{ max-width: 1000px; }</style>

  <script>
    // Read CSS variables for theming
    function cssVar(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }
    function hexToRgb(hex){
      const m = (hex||'').trim().match(/^#?([a-fA-F0-9]{6})$/);
      if(!m){ return [93,134,182]; }
      const int = parseInt(m[1], 16);
      return [(int>>16)&255, (int>>8)&255, int&255];
    }
    function computeAlpha(val, min, max){
      if(!(val>0)) return 0;
      if(!isFinite(min) || max<=0) return 0.6; // fallback
      const lo = Math.min(min, max);
      const hi = Math.max(min, max);
      const t = (hi===lo) ? 1 : Math.max(0, Math.min(1, (val - lo) / (hi - lo)));
      const minA = 0.18, maxA = 0.9;
      return minA + t * (maxA - minA);
    }
  </script>
</head>
<body>
  <div id="loader" class="loader-overlay" aria-live="polite">
    <div class="loader-box">
      <div class="loader-pipeline" aria-hidden="true">
        <div class="pipeline">
          <div class="icon material-symbols-outlined" aria-hidden="true">language</div>
          <div class="flow">
            <span class="packet"></span>
            <span class="packet"></span>
            <span class="packet"></span>
            <span class="packet"></span>
            <span class="packet"></span>
            <span class="packet"></span>
          </div>
          <div class="icon material-symbols-outlined" aria-hidden="true">monitor</div>
        </div>
      </div>
      <div class="loader-message">Retrieving and Aggregating Gabe's Statistics</div>
    </div>
  </div>
  <div class="container page-max">
    <header class="site">
      <div class="brand"><a href="../index.html">GabeFen.com</a></div>
      <nav class="nav">
        <a href="../writing.html">WRITING</a>
        <a href="../recommendations.html">RECOMMENDATIONS</a>
        <a href="../projects.html">PROJECTS</a>
        <a href="../about.html">ABOUT</a>
      </nav>
      <div class="toggle">
        <span>AUTO</span>
        <div class="switch" data-mode="auto" aria-label="Theme toggle"><span class="knob"></span></div>
      </div>
    </header>
    <hr class="rule"/>

    <div class="project-detail-hero">
      <h1 class="post-title">Personal Stats</h1>
      <p>A live dashboard of various metrics I care about tracking</p>
    </div>

    <section class="dash">
      <div class="panel">
        <div class="row-title">Weight Lifting</div>
        <div class="section-row">
          <div id="grid-lift" class="micro-grid" aria-label="Lifting days"></div>
          <div class="metrics">
            <div class="metric-card">
              <div class="label">Per Week</div>
              <div id="avg-lifts-week" class="value">â€”</div>
            </div>
            <div class="metric-card">
              <div class="label">Per Month</div>
              <div id="avg-lifts-month" class="value">â€”</div>
            </div>
          </div>
        </div>

        <div class="row-title">Coffee Consumption</div>
        <div class="section-row">
          <div id="grid-coffee" class="micro-grid" aria-label="Coffee days"></div>
          <div class="metrics">
            <div class="metric-card">
              <div class="label">Per Day</div>
              <div id="avg-coffee-day" class="value">â€”</div>
            </div>
            <div class="metric-card">
              <div class="label">Per Month</div>
              <div id="avg-coffee-month" class="value">â€”</div>
            </div>
          </div>
        </div>

        <div class="row-title">Alcohol Consumption</div>
        <div class="section-row">
          <div id="grid-alcohol" class="micro-grid" aria-label="Alcohol days"></div>
          <div class="metrics">
            <div class="metric-card">
              <div class="label">Per Week</div>
              <div id="avg-alcohol-week" class="value">â€”</div>
            </div>
            <div class="metric-card">
              <div class="label">Per Month</div>
              <div id="avg-alcohol-month" class="value">â€”</div>
            </div>
          </div>
        </div>
      </div>
      <div class="panel">
        <div class="row-title">Typing Speed (Monkeytype)</div>
        <div class="section-row" style="grid-template-columns: 1fr;">
          <div id="typing-speed-panel" style="width:100%">
            <div id="typing-chart" aria-label="Typing speed over time"></div>
            <div id="typing-best-metrics" class="metrics" style="grid-template-columns: repeat(4, 1fr); margin-top: 10px;">
              <div class="metric-card">
                <div class="label">Best 15s</div>
                <div id="best-15" class="value">â€”</div>
              </div>
              <div class="metric-card">
                <div class="label">Best 30s</div>
                <div id="best-30" class="value">â€”</div>
              </div>
              <div class="metric-card">
                <div class="label">Best 60s</div>
                <div id="best-60" class="value">â€”</div>
              </div>
              <div class="metric-card">
                <div class="label">Best 120s</div>
                <div id="best-120" class="value">â€”</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="row-title">Chess Ratings (Lichess)</div>
        <div class="section-row" style="grid-template-columns: 1fr;">
          <div id="lichess-charts" style="width:100%; display:grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-top: 12px; align-items:start;">
            <div>
              <div class="label" style="margin: 0 0 6px; color: var(--muted); text-transform: uppercase; letter-spacing:.06em; font-size: 12px;">Bullet â€” Last 50 Games</div>
              <div id="lichess-bullet-chart" aria-label="Bullet rating progression"></div>
              <div class="metric-card" style="margin-top: 10px;">
                <div class="label">Bullet</div>
                <div id="lichess-bullet" class="value">â€”</div>
              </div>
            </div>
            <div>
              <div class="label" style="margin: 0 0 6px; color: var(--muted); text-transform: uppercase; letter-spacing:.06em; font-size: 12px;">Blitz â€” Last 50 Games</div>
              <div id="lichess-blitz-chart" aria-label="Blitz rating progression"></div>
              <div class="metric-card" style="margin-top: 10px;">
                <div class="label">Blitz</div>
                <div id="lichess-blitz" class="value">â€”</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <footer>
      <p>Â© <span id="y"></span> Gabe Fennema</p>
    </footer>
  </div>

  <script>
    document.getElementById('y').textContent = new Date().getFullYear();

    /* ================== CONFIG: paste your Apps Script Web App URL here ================== */
    const APPSCRIPT_URL = 'https://script.google.com/macros/s/AKfycby_fAkUeg8PNYgvj1i5A1Ryb4-sH6e1dcE_NwtDpz2xkHkHaew01wsf4UJAJfFraoVETw/exec';
    /* ==================================================================================== */

    // Render helpers
    function setMetric(id, val){ document.getElementById(id).textContent = (isFinite(val) ? Number(val).toFixed(1) : 'â€”'); }
    function daysBetween(start, end){ return Math.max(0, Math.round((end - start) / 86400000) + 1); }
    function parseYMD(s){ const [y,m,d] = s.split('-').map(Number); return new Date(y, m-1, d); }

    // Build a weekly grid with gradient fill by value: Y-axis = Sun..Sat, X-axis = weeks (older â†’ newer)
    function renderGrid(el, dayList, valueSelector){
      el.innerHTML = '';

      if(!dayList || dayList.length === 0) return;

      // Fast lookup by date (YYYY-MM-DD)
      const lookup = new Map(dayList.map(d => [d.date, d]));

      // Compute min/max among positive values for gradient scaling
      const values = dayList.map(valueSelector).filter(v => v > 0);
      const minVal = values.length ? Math.min(...values) : Infinity;
      const maxVal = values.length ? Math.max(...values) : 0;
      const [r,g,b] = hexToRgb(cssVar('--accent'));

      // Align to full weeks (Sunday-start, Saturday-end)
      const firstDate = new Date(dayList[0].date);
      const lastDate = new Date(dayList[dayList.length - 1].date);

      const startSunday = new Date(firstDate);
      startSunday.setDate(startSunday.getDate() - startSunday.getDay());
      startSunday.setHours(0,0,0,0);

      // Ensure the grid extends through the current week, even if today's data hasn't arrived yet
      const today = new Date();
      today.setHours(0,0,0,0);
      const endRef = (lastDate < today) ? today : lastDate;

      const endSaturday = new Date(endRef);
      endSaturday.setDate(endSaturday.getDate() + (6 - endSaturday.getDay()));
      endSaturday.setHours(0,0,0,0);

      // Precompute current week range for hiding outlines on future days of this week
      const todayLocal = new Date();
      todayLocal.setHours(0,0,0,0);
      const currentWeekStart = new Date(todayLocal);
      currentWeekStart.setDate(todayLocal.getDate() - todayLocal.getDay());
      const currentWeekEnd = new Date(currentWeekStart);
      currentWeekEnd.setDate(currentWeekStart.getDate() + 6);

      // Iterate weeks leftâ†’right, days topâ†’bottom (Sun=0 .. Sat=6)
      for(let weekStart = new Date(startSunday); weekStart <= endSaturday; weekStart.setDate(weekStart.getDate()+7)){
        for(let dow = 0; dow < 7; dow++){
          const d = new Date(weekStart);
          d.setDate(weekStart.getDate() + dow);
          const key = d.toISOString().slice(0,10);
          const rec = lookup.get(key) || {date:key, coffee:0, alcohol:0, liftHours:0, liftSessions:0, title: `${key} â€¢ â˜• 0 â€¢ ðŸº 0 â€¢ Lift 0h`};

          const sq = document.createElement('div');
          sq.className = 'sq';
          sq.title = rec.title;
          const v = valueSelector(rec) || 0;
          const a = computeAlpha(v, minVal, maxVal);
          if(a > 0){ sq.style.backgroundColor = `rgba(${r}, ${g}, ${b}, ${a})`; }
          // Remove outline for future dates in the current week
          if(d > todayLocal && d >= currentWeekStart && d <= currentWeekEnd){
            sq.style.borderColor = 'transparent';
          }
          el.appendChild(sq);
        }
      }
    }

    function buildDayArray(range, dailyMap){
      const start = parseYMD(range.start);
      const end = parseYMD(range.end);
      const out = [];
      const n = daysBetween(start, end);
      for(let i=0;i<n;i++){
        const d = new Date(start); d.setDate(d.getDate()+i);
        const key = d.toISOString().slice(0,10);
        const rec = dailyMap[key] || {coffee:0, alcohol:0, liftHours:0, liftSessions:0};
        out.push({
          date: key,
          coffee: rec.coffee||0,
          alcohol: rec.alcohol||0,
          liftHours: rec.liftHours||0,
          liftSessions: rec.liftSessions||0,
          title: `${key} â€¢ â˜• ${rec.coffee||0} â€¢ ðŸº ${rec.alcohol||0} â€¢ Lift ${rec.liftHours?.toFixed ? rec.liftHours.toFixed(2) : rec.liftHours}h`
        });
      }
      return out;
    }

    function computeAverages(days){
      if(!Array.isArray(days) || days.length===0){
        return {
          liftsWeek: NaN, liftsMonth: NaN,
          coffeeDay: NaN, coffeeWeek: NaN, coffeeMonth: NaN,
          alcoholWeek: NaN, alcoholMonth: NaN
        };
      }
      const totals = days.reduce((acc, d)=>{
        acc.coffee += Number(d.coffee||0);
        acc.alcohol += Number(d.alcohol||0);
        acc.lifts += Number(d.liftSessions||0);
        return acc;
      }, {coffee:0, alcohol:0, lifts:0});
      const dayCount = days.length;
      const weeks = dayCount / 7;
      const monthsSet = new Set(days.map(d => d.date.slice(0,7))); // YYYY-MM
      const months = Math.max(1, monthsSet.size);

      return {
        liftsWeek: totals.lifts / (weeks || 1),
        liftsMonth: totals.lifts / (months || 1),
        coffeeDay: totals.coffee / (dayCount || 1),
        coffeeWeek: totals.coffee / (weeks || 1),
        coffeeMonth: totals.coffee / (months || 1),
        alcoholWeek: totals.alcohol / (weeks || 1),
        alcoholMonth: totals.alcohol / (months || 1)
      };
    }

    // ===== Monkeytype Typing Speed Chart =====

    function movingAverage(values, windowSize){
      const out = new Array(values.length).fill(null);
      let sum = 0;
      for(let i=0;i<values.length;i++){
        sum += values[i];
        if(i>=windowSize) sum -= values[i-windowSize];
        if(i>=windowSize-1) out[i] = sum / windowSize;
      }
      return out;
    }

    function renderTypingChart(rootEl, attempts){
      if(!rootEl) return;
      rootEl.innerHTML = '';
      if(!attempts || attempts.length===0){
        rootEl.innerHTML = '<div class="muted" style="color:var(--muted); font-size:13px;">No typing results found.</div>';
        return;
      }

      // Prepare data (oldest on left â†’ newest on right)
      attempts.sort((a,b)=> a.ts - b.ts);
      const wpms = attempts.map(a=> Number(a.wpm||0));
      const ma10 = movingAverage(wpms, 10);
      // Only show 10-average per request

      const n = attempts.length;
      const padL = 30, padR = 8, padT = 10, padB = 30;
      const width = rootEl.clientWidth || 640;
      const height = 260;
      const innerW = Math.max(1, width - padL - padR);
      const innerH = Math.max(1, height - padT - padB);

      const allVals = wpms.concat(ma10.filter(Boolean));
      const yMin = Math.max(0, Math.floor(Math.min(...allVals) / 5) * 5);
      const yMax = Math.ceil(Math.max(...allVals) / 5) * 5;
      const x = i => padL + (n===1 ? innerW/2 : (i * (innerW/(n-1))));
      const y = v => padT + innerH - ((v - yMin) / Math.max(1, yMax - yMin)) * innerH;

      const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      svg.setAttribute('width', String(width));
      svg.setAttribute('height', String(height));
      svg.setAttribute('viewBox', `0 0 ${width} ${height}`);

      // Grid lines
      const grid = document.createElementNS(svg.namespaceURI, 'g');
      grid.setAttribute('stroke', getComputedStyle(document.documentElement).getPropertyValue('--rule').trim());
      grid.setAttribute('stroke-opacity', '0.7');
      grid.setAttribute('stroke-width', '1');
      const steps = 5;
      for(let i=0;i<=steps;i++){
        const ty = padT + (innerH/steps)*i;
        const ln = document.createElementNS(svg.namespaceURI, 'line');
        ln.setAttribute('x1', String(padL)); ln.setAttribute('y1', String(ty));
        ln.setAttribute('x2', String(width - padR)); ln.setAttribute('y2', String(ty));
        grid.appendChild(ln);
      }
      svg.appendChild(grid);

      // Helper to build path from series (may contain nulls)
      function seriesPath(series){
        let d = '';
        for(let i=0;i<series.length;i++){
          const v = series[i];
          if(v==null) continue;
          const cx = x(i), cy = y(v);
          d += (d ? ' L' : 'M') + cx + ' ' + cy;
        }
        return d;
      }

      const [r,g,b] = hexToRgb(getComputedStyle(document.documentElement).getPropertyValue('--accent').trim());

      // Avg of 10 line
      const path10 = document.createElementNS(svg.namespaceURI, 'path');
      path10.setAttribute('d', seriesPath(ma10));
      path10.setAttribute('fill', 'none');
      path10.setAttribute('stroke', `rgb(${r},${g},${b})`);
      path10.setAttribute('stroke-width', '3');
      path10.setAttribute('stroke-linecap', 'round');
      svg.appendChild(path10);

      // Individual attempts (dots)
      const dots = document.createElementNS(svg.namespaceURI, 'g');
      dots.setAttribute('fill', `rgba(${r},${g},${b},0.35)`);
      for(let i=0;i<n;i++){
        const c = document.createElementNS(svg.namespaceURI, 'circle');
        c.setAttribute('cx', String(x(i)));
        c.setAttribute('cy', String(y(wpms[i])));
        c.setAttribute('r', '2.5');
        c.setAttribute('tabindex', '0');
        const date = new Date(attempts[i].ts);
        const label = date.toLocaleDateString()+` â€” ${wpms[i].toFixed(1)} wpm`;
        c.setAttribute('aria-label', label);
        c.setAttribute('title', label);
        dots.appendChild(c);
      }
      svg.appendChild(dots);

      // Y-axis labels (top = max, bottom = min)
      const yLabels = document.createElementNS(svg.namespaceURI, 'g');
      const textColor = getComputedStyle(document.documentElement).getPropertyValue('--muted').trim();
      for(let i=0;i<=steps;i++){
        const v = yMax - ((yMax - yMin)/steps)*i;
        const ty = padT + (innerH/steps)*i;
        const t = document.createElementNS(svg.namespaceURI, 'text');
        t.setAttribute('x', String(6));
        t.setAttribute('y', String(ty+4));
        t.setAttribute('font-size', '10');
        t.setAttribute('fill', textColor);
        t.textContent = String(Math.round(v));
        yLabels.appendChild(t);
      }
      svg.appendChild(yLabels);

      rootEl.appendChild(svg);

      // Resize handler
      let rt;
      window.addEventListener('resize', ()=>{ clearTimeout(rt); rt = setTimeout(()=>renderTypingChart(rootEl, attempts), 150); });

      // X-axis labels (evenly spaced indices â†’ dates)
      const xLabels = document.createElementNS(svg.namespaceURI, 'g');
      const spanDays = Math.max(1, (attempts[n-1].ts - attempts[0].ts) / 86400000);
      let dateFmt;
      if(spanDays > 365){ dateFmt = {year:'2-digit', month:'short'}; }
      else if(spanDays > 60){ dateFmt = {month:'short', day:'numeric'}; }
      else { dateFmt = {month:'numeric', day:'numeric'}; }
      const xSteps = 6;
      for(let i=0;i<=xSteps;i++){
        const idx = Math.round((n-1) * (i/xSteps));
        let cx = x(idx);
        const dt = new Date(attempts[idx].ts);
        const tx = document.createElementNS(svg.namespaceURI, 'text');
        let anchor = 'middle';
        if(i===0){ anchor='start'; cx = Math.max(padL, cx) + 2; }
        else if(i===xSteps){ anchor='end'; cx = Math.min(width - padR, cx) - 2; }
        tx.setAttribute('x', String(cx));
        tx.setAttribute('y', String(height - 6));
        tx.setAttribute('font-size', '10');
        tx.setAttribute('fill', textColor);
        tx.setAttribute('text-anchor', anchor);
        tx.textContent = dt.toLocaleDateString(undefined, dateFmt);
        xLabels.appendChild(tx);
      }
      svg.appendChild(xLabels);
    }

    function setTypingBests(best){
      const fmt = v => (isFinite(v) && v>0) ? Math.round(v) : 'â€”';
      const set = (id,val)=>{ const el=document.getElementById(id); if(el) el.textContent = fmt(val); };
      set('best-15', best && best[15]);
      set('best-30', best && best[30]);
      set('best-60', best && best[60]);
      set('best-120', best && best[120]);
    }

    // ===== Lichess Ratings =====
    async function loadLichess(){
      try{
        const res = await fetch('https://lichess.org/api/user/father_gabraham', { headers: { 'Accept': 'application/json' }, cache: 'no-store' });
        if(!res.ok) throw new Error('Lichess fetch failed: ' + res.status);
        const data = await res.json();
        const blitz = data && data.perfs && data.perfs.blitz ? data.perfs.blitz.rating : NaN;
        const bullet = data && data.perfs && data.perfs.bullet ? data.perfs.bullet.rating : NaN;
        const set = (id,val)=>{ const el=document.getElementById(id); if(el) el.textContent = (isFinite(val) ? String(Math.round(val)) : 'â€”'); };
        set('lichess-blitz', blitz);
        set('lichess-bullet', bullet);
      }catch(err){
        console.error(err);
        ['lichess-blitz','lichess-bullet'].forEach(id=>{ const el=document.getElementById(id); if(el) el.textContent='â€”'; });
      }
    }

    async function fetchLichessGames(user, perfType){
      const url = `https://lichess.org/api/games/user/${encodeURIComponent(user)}?max=50&perfType=${encodeURIComponent(perfType)}&pgnInJson=true&clocks=false&moves=false`;
      const res = await fetch(url, { headers: { 'Accept': 'application/x-ndjson' }, cache: 'no-store' });
      if(!res.ok) throw new Error('Lichess games fetch failed: ' + res.status);
      const text = await res.text();
      const lines = text.trim().split('\n').filter(Boolean);
      const games = lines.map(line=>{ try{ return JSON.parse(line); }catch{ return null; } }).filter(Boolean);
      return games;
    }

    function renderRatingChart(rootEl, ratings, bounds){
      if(!rootEl) return;
      rootEl.innerHTML = '';
      if(!ratings || ratings.length===0){
        rootEl.innerHTML = '<div class="muted" style="color:var(--muted); font-size:13px;">No recent games.</div>';
        return;
      }

      const width = rootEl.clientWidth || 640;
      const height = 220;
      const padL = 36, padR = 8, padT = 10, padB = 28;
      const innerW = Math.max(1, width - padL - padR);
      const innerH = Math.max(1, height - padT - padB);

      const n = ratings.length;
      const localMin = Math.min(...ratings);
      const localMax = Math.max(...ratings);
      const yMin = (bounds && isFinite(bounds.yMin)) ? bounds.yMin : Math.floor(localMin / 10) * 10;
      const yMax = (bounds && isFinite(bounds.yMax)) ? bounds.yMax : Math.ceil(localMax / 10) * 10;
      const x = i => padL + (n===1 ? innerW/2 : i * (innerW/(n-1)));
      const y = v => padT + innerH - ((v - yMin) / Math.max(1, yMax - yMin)) * innerH;

      const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      svg.setAttribute('width', String(width));
      svg.setAttribute('height', String(height));
      svg.setAttribute('viewBox', `0 0 ${width} ${height}`);

      // Grid
      const grid = document.createElementNS(svg.namespaceURI, 'g');
      grid.setAttribute('stroke', getComputedStyle(document.documentElement).getPropertyValue('--rule').trim());
      grid.setAttribute('stroke-opacity', '0.7');
      grid.setAttribute('stroke-width', '1');
      const steps = 5;
      for(let i=0;i<=steps;i++){
        const ty = padT + (innerH/steps)*i;
        const ln = document.createElementNS(svg.namespaceURI, 'line');
        ln.setAttribute('x1', String(padL)); ln.setAttribute('y1', String(ty));
        ln.setAttribute('x2', String(width - padR)); ln.setAttribute('y2', String(ty));
        grid.appendChild(ln);
      }
      svg.appendChild(grid);

      // Smooth path (Catmull-Rom to cubic Bezier)
      const [r,g,b] = hexToRgb(getComputedStyle(document.documentElement).getPropertyValue('--accent').trim());
      function catmullRom2bezier(points){
        if(points.length<2){ return ''; }
        if(points.length===2){ return `M${points[0][0]} ${points[0][1]} L${points[1][0]} ${points[1][1]}`; }
        let d = `M${points[0][0]} ${points[0][1]}`;
        const s = 0.25; // smoothing factor (>1/6 for rounder curves)
        for(let i=0;i<points.length-1;i++){
          const p0 = points[i-1] || points[i];
          const p1 = points[i];
          const p2 = points[i+1];
          const p3 = points[i+2] || p2;
          const c1x = p1[0] + (p2[0]-p0[0]) * s;
          const c1y = p1[1] + (p2[1]-p0[1]) * s;
          const c2x = p2[0] - (p3[0]-p1[0]) * s;
          const c2y = p2[1] - (p3[1]-p1[1]) * s;
          d += ` C${c1x} ${c1y}, ${c2x} ${c2y}, ${p2[0]} ${p2[1]}`;
        }
        return d;
      }
      const points = ratings.map((v,i)=>[x(i), y(v)]);
      const d = catmullRom2bezier(points);
      const path = document.createElementNS(svg.namespaceURI, 'path');
      path.setAttribute('d', d);
      path.setAttribute('fill', 'none');
      path.setAttribute('stroke', `rgb(${r},${g},${b})`);
      path.setAttribute('stroke-width', '3');
      path.setAttribute('stroke-linecap', 'round');
      svg.appendChild(path);

      // Dots with tooltips showing delta
      const dots = document.createElementNS(svg.namespaceURI, 'g');
      dots.setAttribute('fill', `rgba(${r},${g},${b},0.4)`);
      for(let i=0;i<n;i++){
        const c = document.createElementNS(svg.namespaceURI, 'circle');
        c.setAttribute('cx', String(x(i)));
        c.setAttribute('cy', String(y(ratings[i])));
        c.setAttribute('r', '2.5');
        const prev = i>0 ? ratings[i]-ratings[i-1] : 0;
        const label = `Game ${i+1} â€” ${ratings[i]} (${prev>=0?'+':''}${prev})`;
        c.setAttribute('aria-label', label);
        c.setAttribute('title', label);
        dots.appendChild(c);
      }
      svg.appendChild(dots);

      // Y axis labels
      const yLabels = document.createElementNS(svg.namespaceURI, 'g');
      const textColor = getComputedStyle(document.documentElement).getPropertyValue('--muted').trim();
      for(let i=0;i<=steps;i++){
        const v = yMax - ((yMax - yMin)/steps)*i;
        const ty = padT + (innerH/steps)*i;
        const t = document.createElementNS(svg.namespaceURI, 'text');
        t.setAttribute('x', String(6));
        t.setAttribute('y', String(ty+4));
        t.setAttribute('font-size', '10');
        t.setAttribute('fill', textColor);
        t.textContent = String(Math.round(v));
        yLabels.appendChild(t);
      }
      svg.appendChild(yLabels);

      // X axis labels removed for cleaner look

      rootEl.appendChild(svg);

      // Responsive
      let rt; window.addEventListener('resize', ()=>{ clearTimeout(rt); rt=setTimeout(()=>renderRatingChart(rootEl, ratings, bounds), 150); });
    }

    async function loadLichessCharts(){
      try{
        const [bulletGames, blitzGames] = await Promise.all([
          fetchLichessGames('father_gabraham', 'bullet'),
          fetchLichessGames('father_gabraham', 'blitz')
        ]);
        // Build rating series oldestâ†’newest; use white or black rating after game
        function extractRatings(games){
          const list = (games||[]).slice().reverse(); // API returns newest first â†’ reverse
          const out = [];
          for(const g of list){
            const you = (g.players && (g.players.white?.user?.name?.toLowerCase()==='father_gabraham')) ? g.players.white : g.players.black;
            const rating = you && (you.rating || you.ratingDiff!=null)
              ? (you.rating ?? (out.length? out[out.length-1] + Number(you.ratingDiff||0) : NaN))
              : NaN;
            out.push(Number(rating));
          }
          return out.filter(v=>isFinite(v));
        }
        const bulletRatings = extractRatings(bulletGames).slice(-50);
        const blitzRatings = extractRatings(blitzGames).slice(-50);

        const combined = bulletRatings.concat(blitzRatings);
        if(combined.length){
          const minCombined = Math.min(...combined);
          const maxCombined = Math.max(...combined);
          const yMin = Math.floor((minCombined - 25) / 10) * 10;
          const yMax = Math.ceil((maxCombined + 25) / 10) * 10;
          const bounds = { yMin, yMax };
          renderRatingChart(document.getElementById('lichess-bullet-chart'), bulletRatings, bounds);
          renderRatingChart(document.getElementById('lichess-blitz-chart'), blitzRatings, bounds);
        } else {
          renderRatingChart(document.getElementById('lichess-bullet-chart'), bulletRatings);
          renderRatingChart(document.getElementById('lichess-blitz-chart'), blitzRatings);
        }
      }catch(err){
        console.error(err);
        const msg = '<div class="muted" style="color:var(--muted); font-size:13px;">Could not load games.</div>';
        const bc = document.getElementById('lichess-bullet-chart'); if(bc) bc.innerHTML = msg;
        const bz = document.getElementById('lichess-blitz-chart'); if(bz) bz.innerHTML = msg;
      }
    }

    async function loadData(){
      try{
        const res = await fetch(APPSCRIPT_URL, {cache:'no-store'});
        if(!res.ok) throw new Error('Fetch failed: ' + res.status);
        const data = await res.json();

        // Convert daily array â†’ map for fast lookups
        const dailyMap = {};
        (data.daily || []).forEach(d => { dailyMap[d.date] = d; });
        const days = buildDayArray(data.range, dailyMap);

        // Grids with gradient intensity (min..max among >0 values)
        renderGrid(document.getElementById('grid-lift'), days, d => (d.liftHours||0));
        renderGrid(document.getElementById('grid-coffee'), days, d => (d.coffee||0));
        renderGrid(document.getElementById('grid-alcohol'), days, d => (d.alcohol||0));

        // Metrics: compute weekly and monthly averages for each
        const avgs = computeAverages(days);
        setMetric('avg-lifts-week', avgs.liftsWeek);
        setMetric('avg-lifts-month', avgs.liftsMonth);
        setMetric('avg-coffee-day', avgs.coffeeDay);
        setMetric('avg-coffee-month', avgs.coffeeMonth);
        setMetric('avg-alcohol-week', avgs.alcoholWeek);
        setMetric('avg-alcohol-month', avgs.alcoholMonth);

        // Typing: render from server-provided data
        const chartRoot = document.getElementById('typing-chart');
        if(chartRoot){
          const typing = data.typing || {};
          if(Array.isArray(typing.attempts) && typing.attempts.length){
            renderTypingChart(chartRoot, typing.attempts);
            setTypingBests(typing.best || {});
          } else {
            chartRoot.innerHTML = '<div class="muted" style="color:var(--muted); font-size:13px;">Monkeytype data unavailable.</div>';
            setTypingBests({15:null,30:null,60:null,120:null});
          }
        }

        // Re-render grids on resize for good density
        let t;
        window.addEventListener('resize', ()=>{ clearTimeout(t); t = setTimeout(()=>{
          renderGrid(document.getElementById('grid-lift'), days, d => (d.liftHours||0));
          renderGrid(document.getElementById('grid-coffee'), days, d => (d.coffee||0));
          renderGrid(document.getElementById('grid-alcohol'), days, d => (d.alcohol||0));
        }, 150); });

        // Theme toggle refresh (borders/accents)
        const toggle = document.querySelector('.switch');
        if(toggle){ toggle.addEventListener('click', ()=>setTimeout(()=>{
          document.querySelectorAll('.sq').forEach(sq => sq.style.borderColor = cssVar('--rule'));
          renderGrid(document.getElementById('grid-lift'), days, d => (d.liftHours||0));
          renderGrid(document.getElementById('grid-coffee'), days, d => (d.coffee||0));
          renderGrid(document.getElementById('grid-alcohol'), days, d => (d.alcohol||0));
        },0)); }
      }catch(err){
        console.error(err);
        [
          'avg-lifts-week','avg-lifts-month',
          'avg-coffee-day','avg-coffee-month',
          'avg-alcohol-week','avg-alcohol-month'
        ].forEach(id => { const el = document.getElementById(id); if(el) el.textContent = 'â€”'; });
        ['grid-lift','grid-coffee','grid-alcohol'].forEach(id => {
          document.getElementById(id).innerHTML = '<div class="muted" style="color:var(--muted); font-size:13px;">Could not load data.</div>';
        });
        const chartRoot = document.getElementById('typing-chart');
        if(chartRoot){ chartRoot.innerHTML = '<div class="muted" style="color:var(--muted); font-size:13px;">Monkeytype data unavailable.</div>'; }
        setTypingBests({15:null,30:null,60:null,120:null});
      } finally {
        const loader = document.getElementById('loader');
        if(loader) loader.classList.add('hidden');
      }
    }

    loadData();
    loadLichess();
    loadLichessCharts();
  </script>

  <script src="../scripts.js"></script>
</body>
</html>


