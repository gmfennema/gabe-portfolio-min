<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Habits Dashboard â€¢ Project â€¢ Gabe Fennema</title>
  <meta name="description" content="Six months of lifting, coffee, and alcohol habits pulled from Google Calendar."/>
  <link rel="stylesheet" href="../styles.css"/>
  <link rel="icon" href="../assets/favicon.png" type="image/png"/>
  <style>
    html[data-theme="dark"] { color-scheme: dark; }
    html[data-theme="light"] { color-scheme: light; }

    /* Layout (borrows structure from your simulator page) */
    .dash{
      margin-top: 24px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 18px;
      align-items: start;
    }
    .panel{
      border: 1px solid var(--rule);
      border-radius: 12px;
      background: var(--bg);
      padding: 16px;
    }
    .panel h2{
      margin: 0 0 12px;
      font-size: 20px;
      line-height: 1.2;
    }

    /* Section rows (grid of tiny squares + metric card on the right like the mock) */
    .section-row{
      display: grid;
      grid-template-columns: 1fr 230px;
      gap: 16px;
      align-items: center;
    }
    @media (max-width: 720px){
      .section-row{ grid-template-columns: 1fr; }
    }

    .metric-card{
      border: 1px solid var(--rule);
      border-radius: 12px;
      background: var(--bg);
      padding: 18px 16px;
      text-align: center;
      min-height: 120px;
      display: grid;
      align-content: center;
      gap: 6px;
    }
    .metric-card .label{
      color: var(--muted);
      font-size: 12px;
      letter-spacing: .06em;
      text-transform: uppercase;
    }
    .metric-card .value{
      font-size: 38px;
      font-weight: 800;
      line-height: 1;
    }

    /* Activity grids oriented as: rows = Sun..Sat, columns = weeks (old â†’ new) */
    .micro-grid{
      --gap: 4px;
      display: grid;
      grid-auto-flow: column;             /* fill by column: topâ†’bottom, then next column */
      grid-template-rows: repeat(7, 1fr); /* 7 rows for days of week (Sun at top) */
      grid-auto-columns: 1fr;             /* each week column shares available width */
      gap: var(--gap);
      width: 100%;
    }
    .sq{
      aspect-ratio: 1;
      border: 1.2px solid var(--rule);
      border-radius: 3px;
      background: transparent;
      transition: background-color .15s ease, border-color .15s ease, transform .05s ease;
    }
    .sq.on{ background: var(--accent); }
    .sq:hover{ transform: translateY(-1px); }

    /* Titles between rows */
    .row-title{
      font-size: 18px;
      margin: 20px 0 10px;
      color: var(--text);
    }

    /* Subtle page motion */
    @keyframes fade-up{ from{opacity:0; transform:translateY(6px);} to{opacity:1; transform:none;} }
    .panel{ animation: fade-up .35s ease both; }
  </style>

  <meta property="og:title" content="Habits Dashboard â€¢ Project â€¢ Gabe Fennema"/>
  <meta property="og:description" content="Six months of lifting, coffee, and alcohol habits pulled from Google Calendar."/>
  <meta property="og:type" content="website"/>
  <meta property="og:url" content="habits-dashboard.html"/>
  <meta name="twitter:card" content="summary"/>
  <meta name="twitter:title" content="Habits Dashboard â€¢ Project â€¢ Gabe Fennema"/>
  <meta name="twitter:description" content="Six months of lifting, coffee, and alcohol habits pulled from Google Calendar."/>
  <link rel="canonical" href="habits-dashboard.html"/>
  <link rel="prefetch" href="../projects.html"/>
  <link rel="prefetch" href="../index.html"/>
  <link rel="prefetch" href="../writing.html"/>

  <style>.page-max{ max-width: 1000px; }</style>

  <script>
    // Read CSS variables for theming
    function cssVar(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }
    function hexToRgb(hex){
      const m = (hex||'').trim().match(/^#?([a-fA-F0-9]{6})$/);
      if(!m){ return [93,134,182]; }
      const int = parseInt(m[1], 16);
      return [(int>>16)&255, (int>>8)&255, int&255];
    }
    function computeAlpha(val, min, max){
      if(!(val>0)) return 0;
      if(!isFinite(min) || max<=0) return 0.6; // fallback
      const lo = Math.min(min, max);
      const hi = Math.max(min, max);
      const t = (hi===lo) ? 1 : Math.max(0, Math.min(1, (val - lo) / (hi - lo)));
      const minA = 0.18, maxA = 0.9;
      return minA + t * (maxA - minA);
    }
  </script>
</head>
<body>
  <div class="container page-max">
    <header class="site">
      <div class="brand"><a href="../index.html">GabeFen.com</a></div>
      <nav class="nav">
        <a href="../writing.html">WRITING</a>
        <a href="../recommendations.html">RECOMMENDATIONS</a>
        <a href="../projects.html">PROJECTS</a>
        <a href="../about.html">ABOUT</a>
      </nav>
      <div class="toggle">
        <span>AUTO</span>
        <div class="switch" data-mode="auto" aria-label="Theme toggle"><span class="knob"></span></div>
      </div>
    </header>
    <hr class="rule"/>

    <div class="project-detail-hero">
      <h1 class="post-title">Habits Dashboard</h1>
      <p class="post-meta">A few key habits I've been tracking visualized with a dashboard using data pulled from Google Calendar refreshed hourly.</p>
    </div>

    <section class="dash">
      <div class="panel">
        <div class="row-title">Weight Lifting</div>
        <div class="section-row">
          <div id="grid-lift" class="micro-grid" aria-label="Lifting days"></div>
          <div class="metric-card">
            <div class="label">Avg Lifts Per Week</div>
            <div id="avg-lifts" class="value">â€”</div>
          </div>
        </div>

        <div class="row-title">Coffee Consumption</div>
        <div class="section-row">
          <div id="grid-coffee" class="micro-grid" aria-label="Coffee days"></div>
          <div class="metric-card">
            <div class="label">Avg Coffee Drinks Per Day</div>
            <div id="avg-coffee" class="value">â€”</div>
          </div>
        </div>

        <div class="row-title">Alcohol Consumption</div>
        <div class="section-row">
          <div id="grid-alcohol" class="micro-grid" aria-label="Alcohol days"></div>
          <div class="metric-card">
            <div class="label">Avg Drinks Per Week</div>
            <div id="avg-alcohol" class="value">â€”</div>
          </div>
        </div>
      </div>
    </section>

    <footer>
      <p>Â© <span id="y"></span> Gabe Fennema</p>
    </footer>
  </div>

  <script>
    document.getElementById('y').textContent = new Date().getFullYear();

    /* ================== CONFIG: paste your Apps Script Web App URL here ================== */
    const APPSCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwt6TNXetojC1XvHD4nS7cFGKw0q1FVXRBTmXAE5XG8njwuTsmR1_iFX7NZhqqO9e_2/exec';
    /* ==================================================================================== */

    // Render helpers
    function setMetric(id, val){ document.getElementById(id).textContent = (isFinite(val) ? Number(val).toFixed(1) : 'â€”'); }
    function daysBetween(start, end){ return Math.max(0, Math.round((end - start) / 86400000) + 1); }
    function parseYMD(s){ const [y,m,d] = s.split('-').map(Number); return new Date(y, m-1, d); }

    // Build a weekly grid with gradient fill by value: Y-axis = Sun..Sat, X-axis = weeks (older â†’ newer)
    function renderGrid(el, dayList, valueSelector){
      el.innerHTML = '';

      if(!dayList || dayList.length === 0) return;

      // Fast lookup by date (YYYY-MM-DD)
      const lookup = new Map(dayList.map(d => [d.date, d]));

      // Compute min/max among positive values for gradient scaling
      const values = dayList.map(valueSelector).filter(v => v > 0);
      const minVal = values.length ? Math.min(...values) : Infinity;
      const maxVal = values.length ? Math.max(...values) : 0;
      const [r,g,b] = hexToRgb(cssVar('--accent'));

      // Align to full weeks (Sunday-start, Saturday-end)
      const firstDate = new Date(dayList[0].date);
      const lastDate = new Date(dayList[dayList.length - 1].date);

      const startSunday = new Date(firstDate);
      startSunday.setDate(startSunday.getDate() - startSunday.getDay());
      startSunday.setHours(0,0,0,0);

      // Ensure the grid extends through the current week, even if today's data hasn't arrived yet
      const today = new Date();
      today.setHours(0,0,0,0);
      const endRef = (lastDate < today) ? today : lastDate;

      const endSaturday = new Date(endRef);
      endSaturday.setDate(endSaturday.getDate() + (6 - endSaturday.getDay()));
      endSaturday.setHours(0,0,0,0);

      // Iterate weeks leftâ†’right, days topâ†’bottom (Sun=0 .. Sat=6)
      for(let weekStart = new Date(startSunday); weekStart <= endSaturday; weekStart.setDate(weekStart.getDate()+7)){
        for(let dow = 0; dow < 7; dow++){
          const d = new Date(weekStart);
          d.setDate(weekStart.getDate() + dow);
          const key = d.toISOString().slice(0,10);
          const rec = lookup.get(key) || {date:key, coffee:0, alcohol:0, liftHours:0, liftSessions:0, title: `${key} â€¢ â˜• 0 â€¢ ðŸº 0 â€¢ Lift 0h`};

          const sq = document.createElement('div');
          sq.className = 'sq';
          sq.title = rec.title;
          const v = valueSelector(rec) || 0;
          const a = computeAlpha(v, minVal, maxVal);
          if(a > 0){ sq.style.backgroundColor = `rgba(${r}, ${g}, ${b}, ${a})`; }
          el.appendChild(sq);
        }
      }
    }

    function buildDayArray(range, dailyMap){
      const start = parseYMD(range.start);
      const end = parseYMD(range.end);
      const out = [];
      const n = daysBetween(start, end);
      for(let i=0;i<n;i++){
        const d = new Date(start); d.setDate(d.getDate()+i);
        const key = d.toISOString().slice(0,10);
        const rec = dailyMap[key] || {coffee:0, alcohol:0, liftHours:0, liftSessions:0};
        out.push({
          date: key,
          coffee: rec.coffee||0,
          alcohol: rec.alcohol||0,
          liftHours: rec.liftHours||0,
          liftSessions: rec.liftSessions||0,
          title: `${key} â€¢ â˜• ${rec.coffee||0} â€¢ ðŸº ${rec.alcohol||0} â€¢ Lift ${rec.liftHours?.toFixed ? rec.liftHours.toFixed(2) : rec.liftHours}h`
        });
      }
      return out;
    }

    function computeFallbackSummary(days){
      const totals = days.reduce((a,d)=>{
        a.c += d.coffee; a.a += d.alcohol; a.lh += d.liftHours; a.ls += d.liftSessions; return a;
      },{c:0,a:0,lh:0,ls:0});
      const dayCount = days.length || 1;
      const weeks = dayCount/7;
      return {
        avgCoffeePerDay: totals.c / dayCount,
        avgDrinksPerWeek: totals.a / weeks,
        avgLiftsPerWeek: totals.ls / weeks
      };
    }

    async function loadData(){
      try{
        const res = await fetch(APPSCRIPT_URL, {cache:'no-store'});
        if(!res.ok) throw new Error('Fetch failed: ' + res.status);
        const data = await res.json();

        // Convert daily array â†’ map for fast lookups
        const dailyMap = {};
        (data.daily || []).forEach(d => { dailyMap[d.date] = d; });
        const days = buildDayArray(data.range, dailyMap);

        // Grids with gradient intensity (min..max among >0 values)
        renderGrid(document.getElementById('grid-lift'), days, d => (d.liftHours||0));
        renderGrid(document.getElementById('grid-coffee'), days, d => (d.coffee||0));
        renderGrid(document.getElementById('grid-alcohol'), days, d => (d.alcohol||0));

        // Metrics (prefer server-side summary; fall back to client calc)
        const summary = data.summary || computeFallbackSummary(days);
        setMetric('avg-lifts', summary.avgLiftsPerWeek);
        setMetric('avg-coffee', summary.avgCoffeePerDay);
        setMetric('avg-alcohol', summary.avgDrinksPerWeek);

        // Re-render grids on resize for good density
        let t;
        window.addEventListener('resize', ()=>{ clearTimeout(t); t = setTimeout(()=>{
          renderGrid(document.getElementById('grid-lift'), days, d => (d.liftHours||0));
          renderGrid(document.getElementById('grid-coffee'), days, d => (d.coffee||0));
          renderGrid(document.getElementById('grid-alcohol'), days, d => (d.alcohol||0));
        }, 150); });

        // Theme toggle refresh (borders/accents)
        const toggle = document.querySelector('.switch');
        if(toggle){ toggle.addEventListener('click', ()=>setTimeout(()=>{
          document.querySelectorAll('.sq').forEach(sq => sq.style.borderColor = cssVar('--rule'));
          renderGrid(document.getElementById('grid-lift'), days, d => (d.liftHours||0));
          renderGrid(document.getElementById('grid-coffee'), days, d => (d.coffee||0));
          renderGrid(document.getElementById('grid-alcohol'), days, d => (d.alcohol||0));
        },0)); }
      }catch(err){
        console.error(err);
        ['avg-lifts','avg-coffee','avg-alcohol'].forEach(id => document.getElementById(id).textContent = 'â€”');
        ['grid-lift','grid-coffee','grid-alcohol'].forEach(id => {
          document.getElementById(id).innerHTML = '<div class="muted" style="color:var(--muted); font-size:13px;">Could not load data.</div>';
        });
      }
    }

    loadData();
  </script>

  <script src="../scripts.js"></script>
</body>
</html>